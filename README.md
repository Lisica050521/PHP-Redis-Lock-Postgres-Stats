# PHP Redis Lock & Postgres Stats

## Описание

Этот проект решает задачу с использованием Redis для блокировки выполнения скрипта и PostgreSQL для хранения и анализа данных по заказам. Проект состоит из двух частей:
1. **PHP скрипт с Redis блокировкой** - предотвращает одновременный запуск нескольких экземпляров скрипта.
2. **База данных PostgreSQL** - хранит информацию о заказах и других связанных данных, а также собирает статистику о покупках.

## Структура проекта

```
│── /php_script/        # Скрипты на PHP с логикой Redis  
│   ├── script.php      # Основной PHP-скрипт  
│   ├── lock.php        # Логика блокировки через Redis  
│   ├── .env            # Переменные окружения
│   ├── config.php      # Конфигурация Redis  
│── /database/          # База данных PostgreSQL  
│   ├── schema.sql      # SQL для создания таблиц  
│   ├── trigger.sql     # SQL-код для триггера  
│   ├── seed.sql        # Заполнение базы тестовыми данными  
│── .gitignore          # Исключает ненужные файлы  
│── composer.json       # Конфигурация зависимостей Composer  
│── composer.lock       # Файл блокировки зависимостей Composer  
│── README.md           # Описание проекта и инструкции  

```

## Требования

- PHP 8.2 или выше
- Redis
- PostgreSQL
- Composer для управления зависимостями

## Установка

### 1. Установка зависимостей для PHP:

1. Клонируйте репозиторий:
   ```bash
   git clone https://github.com/Lisica050521/PHP-Redis-Lock-Postgres-Stats
   cd PHP-Redis-Lock-Postgres-Stats
   ```

2. Установите все зависимости с помощью Composer:
   ```bash
   composer install
   ```

3. Установите библиотеку Predis для работы с Redis::
   ```bash
   composer require predis/predis
   ```  

### 2. Настройка Redis:
#### 2.1 Настройка Redis (через Docker):
Если вы хотите использовать Docker для запуска Redis, выполните следующие шаги:

1. Убедитесь, что у вас установлен Docker. Если нет, его можно скачать и установить с официального сайта: https://www.docker.com/get-started.
2. Запустите Redis в контейнере Docker с помощью следующей команды:

   ```bash
   docker run --name redis -p 6379:6379 -d redis
   ```

3. После этого Redis будет доступен на порту 6379 вашего хоста. Убедитесь, что в файле .env указаны правильные параметры:р:
   ```
   REDIS_HOST=127.0.0.1
   REDIS_PORT=6379
   LOCK_KEY=script_lock
   LOCK_DURATION=10
   ```
#### 2.2. Установка Redis (без Docker):
Если вы не используете Docker, установите Redis вручную на вашу операционную систему. Инструкции можно найти на официальном сайте Redis: https://redis.io/dow

### 3. Настройка PostgreSQL:

1. Создайте базу данных PostgreSQL:
   ```sql
   CREATE DATABASE order_stats;
   ```

2. Выполните SQL скрипты для создания таблиц и триггера:
   ```sql
   \i /путь_к_проекту/database/schema.sql
   \i /путь_к_проекту/database/trigger.sql
   \i /путь_к_проекту/database/seed.sql
   ```
   
3. После того как данные будут вставлены, выполните следующие запросы для проверки, что всё работает корректно:

Проверка таблицы statistics:
   ```sql
SELECT * FROM statistics;
   ```

Строки статистики должны обновляться при добавлении заказов. 

Проверка таблицы orders:

   ```sql
SELECT * FROM orders;
   ```
Убедитесь, что таблица заказов заполняется корректно, и что в каждом заказе есть временная метка, когда он был добавлен.

### 4. Запуск скрипта:

Запуск скрипта можно выполнить следующим образом:

```bash
php php_script/script.php
```

Если все настроено правильно:

```
Скрипт начал выполнение...
(пауза 5 секунд)
Скрипт завершил выполнение!
```

## Как проверить, что защита работает?

### 1. Запуск скрипта дважды с небольшим интервалом:

1. Откройте два терминала и запусти команду одновременно в обоих:

   ```bash
   php php_script/script.php
   ```

2. **Ожидаемый результат**:
    - В первом терминале скрипт будет выполняться 5 секунд.
    - Во втором терминале должно появиться сообщение:
      ```
      Скрипт уже выполняется! Ожидайте...
      ```

Это значит, что блокировка работает, и второй запуск был заблокирован, пока выполняется первый.

### 2. Проверка в Redis, что ключ блокировки есть:

1. Во время выполнения скрипта можно проверить в Redis, есть ли ключ блокировки.
2. Откройте Redis CLI (если Redis запущен через Docker):
   ```bash
   docker exec -it redis redis-cli
   ```

3. Введите команду для получения всех ключей:
   ```bash
   KEYS *
   ```

   Если защита работает, можно увидеть ключ блокировки, например, `script_lock`.

4. Чтобы посмотреть TTL (время жизни) ключа:
   ```bash
   TTL script_lock
   ```

    - Если TTL равен `-1`, значит, время жизни не установлено (неправильная настройка блокировки).
    - Если TTL больше 0, значит, ключ удалится сам через заданное время (время жизни задано корректно).

### 3. Как проверить, что блокировка снимается после завершения:

1. Запусти скрипт:
   ```bash
   php php_script/script.php
   ```

2. Пока он выполняется (5 секунд), в другом терминале зайдите в Redis CLI и введите:
   ```bash
   KEYS *
   ```

   Если ключ `script_lock` существует, это значит, что блокировка активна.

3. Подожди завершения скрипта (5 секунд) и снова введи:
   ```bash
   KEYS *
   ```

   Если ключа нет, значит блокировка снялась корректно.


